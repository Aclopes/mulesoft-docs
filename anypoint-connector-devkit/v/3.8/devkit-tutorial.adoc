= Tutorial: Build a Connector
:keywords: devkit tutorial, features, cookbook
:imagesdir: ./_images
:resourcesDir: resources
:tutorial: Cookbook
:author: MuleSoft Inc.


toc::[]


Learn how to create a connector to a web service using the Anypoint Connector DevKit.

This tutorial shows you how to code a connector to support authentication, connections, and service operations. This tutorial provides a foundation to code more complex functionality into a connector.

== Before You Begin

Before developing a connector you should have a working knowledge of link:/getting-started/index[Mule], link:/anypoint-studio/v/6/download-and-launch-anypoint-studio[Anypoint Studio], Java development and the use of https://docs.oracle.com/javase/tutorial/java/annotations/basics.html[Java annotations].

Perform the steps to link:/anypoint-connector-devkit/v/3.8/setting-up-your-dev-environment[Set Up Your Development Environment]

== Steps to Build the Cookbook Connector

These are the general steps you complete in the tutorial that allow you to build a basic connector.

. Clone the Cookbook code on your local machine and import into Studio.
. Create an Anypoint Connector Project in Studio.
. Add in the Maven pom file the dependency that contains the client used to connect to the Cookbook service.
. Define a configurable field designed for users to input the URL to start a connection.
. Define an operation for the connector.
. Include code that allows the connector to manage connections to the Cookbook service.

[[get-cookbook]]
== Clone and Import the Cookbook Repository

Install the cookbook from GitHub:

. Clone the link:https://github.com/mulesoft/mule-cookbook[https://github.com/mulesoft/mule-cookbook] repository to your computer by running:
+
[source,bash,linenums]
----
cd ~/dev
git clone https://github.com/mulesoft/mule-cookbook.git
----
+
. Enter the directory `mule-cookbook` and run the following Maven command:
+
[source,bash,linenums]
----
mvn install eclipse:eclipse
----
+
. Open Anypoint Studio, import the `mule-cookbook` directory as an existing project. *File* > *Import* > *Existing Projects into Workspace*.
+
image::devkit-tutorial-30756.png[import existing - mule-cookbook]

This should create the several folders you see on the above screen in your workspace in Studio, which is visible in the *Package Explorer*.

== Create the {tutorial} Connector Project in Studio

With the `mule-cookbook` directory imported as an existing project into your workspace as instructed link:#get-cookbook[above], you can begin to create the connector project and start coding.

. In Anypoint Studio, click *File* > *New* > *Anypoint Connector Project* or right-click your project name in Package Explorer and click *New* > *Anypoint Connector Project*:
+
image::new-connector-1.png[width="500"]
+
. Select the project type you want to create. In this case, select *SDK Based*:
+
image::new0.png[width="500"]
+
. Specify the name of your connector and don't forget to uncheck the default generation before clicking *Finish*:
+
image:new1.png[width="550"]
+
This generates a project containing the structure and all required elements including a skeleton connector, icons, sample docs file, but no basic tests for your connector.
+
image::new-connector-3.png[width="600","new-connector-3"]

[TIP]
You can enable the DevKit view by clicking from the top bar *Window* > *Show View* > *Other*, and look for DevKit in the *MuleSoft* dropdown.

image::enable-view.png[width="300"]

DevKit view shows a compact view of the connector configuration options and connector operations.

image::devkit-tutorial-6640a.png[]


== Specify Connector Dependencies in pom.xml

. Search for your pom.xml file in your project and open it so you can add the XML dependency snippet.
. Copy the Cookbook client dependency into the pom.xml so the Java API can be used to connect to the {tutorial}.
+
In your pom.xml file add:
+
[source,xml,linenums]
----
<dependencies>
  <dependency>
    <groupId>org.mule.modules</groupId>
    <artifactId>sdk-client</artifactId>
    <version>1.0.0-SNAPSHOT</version>
  </dependency>
</dependencies>
----


== Define a Configurable Field for Connection URL

. Open the `ConnectorConfig.java` file. You can find the file from the DevKit view of the connector project.
. Add a configurable field annotated with `@Configurable`. This is for the address where the {tutorial} service is hosted.
Type *conf* at the editor of your connector config and use the `control` + `space` shortcut to select the option *configurable - Configurable element with default*
+
image::config-field.png[width="600"]
+
. Specify a default endpoint in the code `+@Default("http://devkit-cookbook.cloudhub.io/soap")+` so it looks like this.
+
[source,java,linenums]
----
@Configurable
	@Default("http://devkit-cookbook.cloudhub.io/soap")
	private String address;
----
+
. Any field marked with the `@Configurable` annotation must have a getter and a setter for that field.
+
See the sample getter and setter in the full link:https://github.com/mulesoft/mule-cookbook-tutorial/blob/master/src/main/asciidoc/resources/java/v1/ConnectorConfig.java[ConnectorConfig.java] source code.

== Add Code to Initialize the Cookbook Client

. In your `@Connector`-annotated class in the `Connector.java` file use the `@Start` annotation on a method to initialize the client.
+
[source,java,linenums]
----
include::{resourcesDir}/java/v1/CookbookConnector.java[lines=30..35]
----
. Ensure you have the same import statements at this point in the tutorial as link:http://mulesoft.github.io/mule-cookbook-tutorial/resources/java/v1/CookbookConnector.java[Connector.java] source code.

[NOTE]
====
Anypoint Connectors are made to be fully aware of Mule runtime's lifecycle without implementing any Mule-specific interface.

There is an annotation method for each of the four phases of the lifecycle.

When a method is annotated with one of these annotations, DevKit invokes it during the lifecycle phase that the annotation represents.
====

[[processor]]
== Code an Operation into the Connector

`getRecentlyAdded` is an operation we can implement quickly to start learning how to build our connector. The `getRecentlyAdded` call doesn't require authentication.

The Cookbook client you are using provides a login call that initializes the token and uses it in subsequent requests.

. Open the `Connector.java` file.
. Remove the dummy operation you see annotated with `@Processor`.
+
. Add a new processor in its place. Type *proc* in the Studio code editor and use the shortcut as before, `ctrl` + `space` to display the templates and choose from the dropdown *processor - a simple processor...*.
+
image::processor1.png[width="600"]
+
. Change it to reflect the `getRecentlyAdded` method signature (see example implementation link:https://github.com/mulesoft/mule-cookbook-tutorial/blob/master/src/main/asciidoc/resources/java/v1/CookbookConnector.java#L46[here]), and at this point you have the code in place to build your first connector, which should then be ready for testing.
. Check you have the correct import statements for the code you have added up to this point.
. Run the Generate Sources command from the console: `mvn clean package -DskipTests -Ddevkit.studio.package.skip=true -Ddevkit.javadoc.check.skip=true -Dmaven.javadoc.skip=true` and check for any errors, especially regarding import statements.
+
You can check your work and see the full link:https://github.com/mulesoft/mule-cookbook-tutorial/blob/master/src/main/asciidoc/resources/java/v1/CookbookConnector.java[Connector] source code.

[NOTE]
Resolve any package import errors by right-clicking your connector project in the Package Explorer of Studio. *Build Path* > *Add External Archives*. Add the applicable .jar files, for example, so your project can reference the cookbook `sdk-client`. This should stop any import errors on:
`import com.cookbook.tutorial.client.MuleCookBookClient;`
`import com.cookbook.tutorial.service.Recipe;`

You can check references in the properties for your project.

image::devkit-tutorial-af283.png[properties for cookbook connector project]

At this point you can <<install-guide,install>> this Connector and try it in Studio if you want.

[IMPORTANT]
====
As you modify your connector, you may start seeing error markers on the generated folder.

Just ignore them.

Once you regenerate the sources, the errors will go away as the generated code will be refreshed.
====


== Enable Connection Handling

The session can expire and cause the connector to make a login request again.

DevKit provides a set of annotations to keep your code clean and handle the connection.

. In the `Config.java` file, change `@Configuration` to `@ConnectionManagement`
+
[source,java,linenums]
----
include::{resourcesDir}/java/v2/ConnectorConfig.java[lines=29]
----
+
. Make sure you have equipped the `MuleCookbookClient` in the `ConnectorConfig.java` with a getter and a setter.
+
[source,java,linenums]
----
include::{resourcesDir}/java/v2/ConnectorConfig.java[lines=91..100]
----
+
. Implement these four methods as shown:
+
* *`@Connect`* - Initialize the client, and if the login does not succeed, throw an exception.
+
[source,java,linenums]
----
include::{resourcesDir}/java/v2/ConnectorConfig.java[lines=41..50]
----
+
* *`@Disconnect`* - Release a connection.
+
[source,java,linenums]
----
include::{resourcesDir}/java/v2/ConnectorConfig.java[lines=55..58]
----
+
* *`@ValidateConnection`* - Check if your connection is alive.
+
[source,java,linenums]
----
include::{resourcesDir}/java/v2/ConnectorConfig.java[lines=63..66]
----
+
* *`@ConnectionIdentifier`* - Return a string value. This will only be used when debugging.
+
[source,java,linenums]
----
include::{resourcesDir}/java/v2/ConnectorConfig.java[lines=71..74]
----
+
. Remove the declaration of `MuleCookBookClient` from  `CookbookConnector.java` and remove the method where a new `MuleCookBookClient` client is instantiated.
+
[source,java,linenums]
----
	private MuleCookBookClient client;

	@Start
	public void initialize() {
		client = new MuleCookBookClient(config.getAddress());
	}
----
+
. In our `getRecentlyAdded` method (annotated as a `@Processor`) call the `getclient` method, which should be defined in `ConnectorConfig.java`.
+
[source,java,linenums]
----
include::{resourcesDir}/java/v2/CookbookConnector.java[lines=35..38]
----

See:

* link:https://github.com/mulesoft/mule-cookbook-tutorial/blob/master/src/main/asciidoc/resources/java/v2/CookbookConnector.java[Connector] source code.

* link:https://github.com/mulesoft/mule-cookbook-tutorial/blob/master/src/main/asciidoc/resources/java/v2/ConnectorConfig.java[Config] source code.

If you install this version and try to run the Mule app we created earlier, you will see that it fails with a "SAXParseException" because we need to add a username and password to our configuration.

Just open the global configuration of your connector and check that there are two new fields, username and password. Configure them and you can run the app again.

image::connection-management.png[width="600"]

This is the updated Mule app XML:

[source,xml,linenums]
----
<?xml version="1.0" encoding="UTF-8"?>

<mule xmlns:cookbook="http://www.mulesoft.org/schema/mule/cookbook" xmlns:json="http://www.mulesoft.org/schema/mule/json" xmlns:http="http://www.mulesoft.org/schema/mule/http" xmlns="http://www.mulesoft.org/schema/mule/core" xmlns:doc="http://www.mulesoft.org/schema/mule/documentation"
      xmlns:spring="http://www.springframework.org/schema/beans"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/beans http://www.springframework.org/schema/beans/spring-beans-current.xsd
http://www.mulesoft.org/schema/mule/core http://www.mulesoft.org/schema/mule/core/current/mule.xsd
http://www.mulesoft.org/schema/mule/http http://www.mulesoft.org/schema/mule/http/current/mule-http.xsd
http://www.mulesoft.org/schema/mule/json http://www.mulesoft.org/schema/mule/json/current/mule-json.xsd
http://www.mulesoft.org/schema/mule/cookbook http://www.mulesoft.org/schema/mule/cookbook/current/mule-cookbook.xsd">
    <http:listener-config name="HTTP_Listener_Configuration" host="0.0.0.0" port="8081" doc:name="HTTP Listener Configuration"/>
    <cookbook:config name="Cookbook__Configuration" doc:name="Cookbook: Configuration type config" password="admin" username="admin"/>
    <flow name="mule-appFlow">
        <http:listener config-ref="HTTP_Listener_Configuration" path="/get-recently" doc:name="HTTP"/>
        <cookbook:get-recently-added config-ref="Cookbook__Configuration" doc:name="Cookbook"/>
        <json:object-to-json-transformer doc:name="Object to JSON"/>
    </flow>
</mule>
----

* Understand link:http://mulesoft.github.io/connector-certification-docs/advanced/index.html#_test_connectivity[Testing Connectivity].
* See documentation on setting up link:/anypoint-connector-devkit/v/3.8/authentication[Authentication] using DevKit.

== Customize Exception and Error Handling

This section explains how to improve exception handling and errors.

The `@Handler` annotation is useful for avoiding duplicate code for handling exceptions, and makes your code easier to read.

When handling messages retrieved from the API, if you see the message is uninformative and you know how to improve it, use the `@Handler` mechanism to enrich the error information provided to the user.

To see how it works, let's create a handler in the connector code for the `InvalidEntityException` thrown by the Cookbook SDK `create()` call:

.This `create()` call from `MuleCookBookClient.java` throws `InvalidEntityException`
[source,java,linenums]
----
@Override
   public CookBookEntity create(CookBookEntity entity) throws InvalidEntityException,
           SessionExpiredException {
       Create request = factory.createCreate();
       request.setEntity(entity);
       try {
           return port.create(request, token).getReturn();
       } catch (InvalidTokenException e) {
           logger.warn("Should never happen.", e);
           throw new RuntimeException(e);
       }
     }
----

. Create a new *Anypoint Connector Component* by right-clicking and navigating to that item in the menu, or via *New* > *Other*, selecting this option in the wizard.
+
image::new-component.png[width="600"]
+
. Select the package, component type and class name and click on Finish.
+
image::new-component-2.png[width="600"]
+
. Improve the error message when `InvalidEntityException` is thrown.
+
[source,java,linenums]
----
include::{resourcesDir}/java/v3/CookbookHandler.java[lines=11..19]
----
+
Check the full link:https://github.com/mulesoft/mule-cookbook-tutorial/blob/master/src/main/asciidoc/resources/java/v3/CookbookHandler.java[source code].
+
. Add a new processor to create Ingredients, noticing how it references the exception handler we included.
+
[source,java,linenums]
----
include::{resourcesDir}/java/v3/CookbookConnector.java[lines=59..63]
----
+
Check the full link:https://github.com/mulesoft/mule-cookbook-tutorial/blob/master/src/main/asciidoc/resources/java/v3/CookbookConnector.java[source code].



== Testing Your Connector

* You can add breakpoints in the source code of the connector to assist with debugging.
* After installing your connector in Studio, you can test it in a Mule app.
* To correctly debug your code, make sure that the Mule app you are running is using the latest installed version of the connector.


== See Also

* link:https://github.com/mulesoft/mule-cookbook-connector[Cookbook Connector Source Code]
* link:https://docs.mulesoft.com/anypoint-connector-devkit/v/3.8/installing-and-testing-your-connector-in-studio[Installing and Testing Your Connector]
* link:/mule-user-guide/v/3.8/anypoint-connectors[Anypoint Connectors]
* link:/anypoint-connector-devkit/v/3.8/creating-a-java-sdk-based-connector[Creating a Java SDK Based Connector]
